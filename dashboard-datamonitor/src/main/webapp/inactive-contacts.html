<!doctype html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <!-- Meta, title, CSS, favicons, etc. -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>Contacts | Active/Inactive Contacts</title>
    <!-- Font Awesome -->
    <link href="media/css/font-awesome.min.css" rel="stylesheet">    
    <link href="media/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="media/css/dataTables.bootstrap.min.css">
   
    <script src="media/js/jquery-min.js"></script>    
	<script type="text/javascript" src="media/js/moment/moment.min.js"></script>
 
	<!-- Include date range picker plugin -->
	<script type="text/javascript" src="media/js/datepicker/daterangepicker.js"></script>
	<link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/bootstrap.daterangepicker/1/daterangepicker-bs3.css" />
    <link href="https://cdn.datatables.net/buttons/1.2.2/css/buttons.dataTables.min.css" rel="stylesheet">
    <link href="https://cdn.datatables.net/colreorder/1.3.2/css/dataTables.colReorder.min.css" rel="stylesheet">
    <link rel="stylesheet" href="http://code.jquery.com/ui/1.8.23/themes/base/jquery-ui.css">
    <script src="media/js/jquery-ui.js"></script>  
        
    <!-- load jquery -->
    <!-- load datatables js library -->
    <script type="text/javascript" src="media/js/jquery.dataTables.min.js"></script>
    <script type="text/javascript" src="media/js/dataTables.bootstrap.min.js"></script>
    <script type="text/javascript" src="media/js/json2.js"></script>
    <script type="text/javascript" src="https://cdn.datatables.net/colreorder/1.3.2/js/dataTables.colReorder.min.js"></script>
    <script type="text/javascript" src="https://cdn.datatables.net/buttons/1.2.2/js/dataTables.buttons.min.js"></script>
    <script type="text/javascript" src="//cdn.datatables.net/buttons/1.2.2/js/buttons.flash.min.js"></script>
    <script type="text/javascript" src="//cdn.datatables.net/buttons/1.2.2/js/buttons.html5.min.js"></script>
    <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/jszip/2.5.0/jszip.min.js"></script>
    <script type="text/javascript" src="//cdn.rawgit.com/bpampuch/pdfmake/0.1.18/build/vfs_fonts.js"></script>
    
    <style>
		.h1, .h2, .h3, h1, h2, h3 {
			margin-top: 5px !important;
			margin-bottom: 5px !important;
		}body {
			color: #73879C !important;
		}li a {
		  color:#5A738E !important;
		}h2{
		 font-size:23px !important;
		}
	</style>
	
	
</head>

<body style="background-color:#ffffff;">
       <div style="padding:0px 20px 0px 20px;">
         <div style="text-align:center;;font-size:30px;margin:10px;"><strong>Zambia â€“ Farmer SMS Data</strong></div>
         <div class="right_col" role="main"  style="margin:0 auto">
            <div>
               <ul class="nav nav-tabs" role="tablist" style="font-size:18px;">
                  <li class="active">
                     <a href="new-dashboard.html">Zambia</a>
                  </li>
                  <li>
                     <a href="new-dashboard.html">Kenya</a>
                  </li>
               </ul>
			 </div>
		</div>
		
		<div>
			<ul class="nav nav-tabs" role="tablist" style="font-size:15px">
			   <li>
				  <a href="new-dashboard.html">Monitoring</a>
			   </li>
			   <li class="active">
				  <a href="#">Tables and Metadata</a>
			   </li>
			</ul>
		</div>
		
		<div style="margin-top:20px;"></div>
		<h4>Click below buttons to access your needful tables</h4>
		<div style="margin-top:20px;"></div>
		<a href="flow-metadata.html" class="btn btn-default active" role="button">Flow Metadata Management</a>
		<a href="contact-metadata.html" class="btn btn-default active" role="button">Contact Metadata Management</a>
		<a href="inactive-contacts.html" class="btn btn-default active" role="button">Download Inactive Contacts</a>
		<a href="question-response.html" class="btn btn-default active" role="button">Download Farmers Responses</a>
        <!-- page content -->
        <div class="right_col" role="main" style="padding:10px 0px 20px 0px;">
            
            <div class="row">
              <div class="col-md-12 col-sm-12 col-xs-12">
                <div class="dashboard_graph x_panel">
                  <div class="row x_title">
                    <div class="col-md-6 col-sm-6 col-xs-6">
                      <h3>Inactive Farmers Table <small> -  For a given time period</small></h3>
                    </div>
                    <div class="col-md-6 col-sm-6 col-xs-6">
                      <div id="contact_response" class=" pull-right" style="background: #fff; cursor: pointer; padding: 10px;">
						<label for="to">Last Response Date</br><span style="font-size: 10px;">(select a date to see the list of farmers who didn't respond till now)</span></label>
                        <input type="text" id="to" name="to">
                      </div>                      
                    </div>
                    <hr>
                    <div class="form-group">
                        <div class="col-md-9 col-sm-9 col-xs-12 col-md-offset-3"  style="padding-top: 5px;">
                          <button type="submit" class="btn btn-success pull-right" id="saveBtn">Submit</button>
                        </div>
                     </div>
                  </div>
                    <div class="tab-pane" id="tab-table5">
						<div id="failure" style="padding:20px;" align="center"></div>
                        <table id="contactInfoTable" class="table table-striped table-bordered" width="100%" cellspacing="0">
                        </table>
                        
                        <div style="margin-top:50px;"></div>
                    </div>
                  <div class="clearfix"></div>
                </div>
              </div>
            </div>   
		</div>       
	</div>
   
    <script type="text/javascript">
	$(document).ready(function() {	
		
		function AjaxNoDataFailed() {
			$('#failure').html(""); //Clear error span
			$('#failure').append("<span class='alert alert-warning' style='align:center;padding:10px;font-size:20px'><strong>Warning! </strong>" + 'No data available for a given time period' + "<br></span>");
			
		}
		
		function renderTable(xhrdata) {
		var cols = [];
		if(xhrdata.length == 0){
			AjaxNoDataFailed();
		}else{
			$('#failure').html(""); //Clear error span
			var exampleRecord = xhrdata[0];

			var keys = Object.keys(exampleRecord);

			keys.forEach(function(k) {
			  cols.push({
				title: k,
				data: k
				  //optionally do some type detection here for render function
			  });
			});

			var table = $('#contactInfoTable').DataTable({
				columns: cols,
				dom: 'Blfrtip',
				lengthMenu: [ 10, 50, 100 ],
				order: [ 7, "asc" ],
				buttons: [
					{
						extend: 'excel',
						title: "inactive_contacts",
						text:'Download Excel File',
						exportOptions: {
						columns: [4,5,7,11]
					}
					}
				],
				columnDefs: [
					{ 
						visible: false, 
						targets: 0 
					},
					{ 
						visible: false, 
						targets: 1 
					},
					{ 
						visible: false, 
						targets: 2 
					},
					{ 
						visible: false, 
						targets: 3 
					},
					{ 
						visible: false, 
						targets: 6 
					},
					{
                		type : "datetime",
						render: function ( data, type, row ) {
								var mom_date = moment(data);
								var new_date = mom_date.format('YYYY-MM-DD h:mm A');
    							return new_date;
						},
						targets: 7,
						dateFormat: "yy-mm-dd"
					},
					{ 
						visible: false, 
						targets: 8 
					},
					{ 
						visible: false, 
						targets: 9 
					},
					{ 
						visible: false, 
						targets: 10 
					}
				]
			});

			table.rows.add(xhrdata).draw();
		}

		}
		
		var now = new Date();
		var today = new Date(now.getFullYear(), now.getMonth(), now.getDate());		
        var last_month = new Date(today.getFullYear(), today.getMonth()-1, today.getDate());
		
		tdate = new Date(moment(last_month).format('D MMMM YYYY'));
		tdate_sr = new Date(tdate.setHours(tdate.getHours()+11))
		tdate_sr_lk = moment(tdate_sr).format("YYYY-MM-DDTHH:mm:ss.SSS");
		
		var to_date = tdate_sr_lk + "Z";

		//var textit_prefix = "http://localhost:8080/textit-api/zambia";
		var textit_prefix = "http://smallholderag-test.d2i.indiana.edu:8080/textit-api/zambia";
			
		//xhr call to retrieve data
	    var xhrcall = $.ajax(textit_prefix + "/contacts?lastRespondedSort=1&lastRespondedTo=" + to_date);

	  	//promise syntax to render after xhr completes
	    xhrcall.done(renderTable);
		

		$( "#to" ).datepicker({
				defaultDate: "+1w",
				changeMonth: true,
				beforeShowDay: noSunday,
				minDate: "01/01/2014",
				maxDate: new Date(),
				numberOfMonths: 2,
				onSelect: function( selectedDate ) {
					if(this.id == 'to'){
					  var dateMax = $('#to').datepicker("getDate");
					  var toMax = new Date(dateMax.getFullYear(), dateMax.getMonth(),dateMax.getDate()-1);
					}
					
				}
			});
	
			function noSunday(date) {
				var day = date.getDay();
				return [(day == 1), ''];
			};

    //Set the initial state of the picker label	
	$('#to').val(moment(last_month).format('D MMMM YYYY'));
		
	function wait(ms){
	   var start = new Date().getTime();
	   var end = start;
	   while(end < start + ms) {
		 end = new Date().getTime();
	  }
	}
	
		
	$('#saveBtn').click(function(){
		function renderTableClick(xhrdata) {
		var cols = [];
		if(xhrdata.length == 0){
			AjaxNoDataFailed();
		}else{
			$('#failure').html(""); //Clear error span
			var exampleRecord = xhrdata[0];

			var keys = Object.keys(exampleRecord);

			keys.forEach(function(k) {
			  cols.push({
				title: k,
				data: k
				  //optionally do some type detection here for render function
			  });
			});

			var table = $('#contactInfoTable').DataTable({
				columns: cols,
				dom: 'Blfrtip',
				order: [ 7, "asc" ],
				lengthMenu: [ 10, 50, 100 ],
				buttons: [
					{
						extend: 'excel',
						title: "inactive_contacts",
						text:'Download Excel File',
						exportOptions: {
						columns: [4,5,7,11]
					}
					}
				],
				columnDefs: [
					{ 
						visible: false, 
						targets: 0 
					},
					{ 
						visible: false, 
						targets: 1 
					},
					{ 
						visible: false, 
						targets: 2 
					},
					{ 
						visible: false, 
						targets: 3 
					},
					{ 
						visible: false, 
						targets: 6 
					},
					{
                		type : "datetime",
						render: function ( data, type, row ) {
								var mom_date = moment(data);
								var new_date = mom_date.format('YYYY-MM-DD h:mm A');
    							return new_date;
						},
						targets: 7,
						dateFormat: "yy-mm-dd"
					},
					{ 
						visible: false, 
						targets: 8 
					},
					{ 
						visible: false, 
						targets: 9 
					},
					{ 
						visible: false, 
						targets: 10 
					}
				]
			});

			table.rows.add(xhrdata).draw();
		}

		}
		
		
		to_date = $('#to').val();		
		
		new_end_date = new Date(to_date);
		new_end_date_sr = new Date(new_end_date.setHours(new_end_date.getHours()+11))
		new_end_date_sr_lk = moment(new_end_date_sr).format("YYYY-MM-DDTHH:mm:ss.SSS");
		
		var new_to_date = new_end_date_sr_lk + "Z";
		
		info_submit_data = [];
		
		//xhr call to retrieve data
		var xhrcall = $.ajax(textit_prefix + "/contacts?lastRespondedSort=1&lastRespondedTo=" + new_to_date);

		if(xhrcall.responseText != "[]"){
			if ($.fn.DataTable.isDataTable( '#contactInfoTable' ) ) {
					$('#contactInfoTable').DataTable().destroy();	// Destroy dataTable
  					$('#contactInfoTable').empty();
				}
			
				// empty in case the columns change (Remove DOM elements)
			xhrcall.done(renderTableClick);
		}
		
	});
		
 });
</script>
</body>
</html>
