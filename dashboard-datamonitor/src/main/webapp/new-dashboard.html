<!DOCTYPE html>
<html lang="en">
   <head>
      <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
      <!-- Meta, title, CSS, favicons, etc. -->
      <meta charset="utf-8">
      <meta http-equiv="X-UA-Compatible" content="IE=edge">
      <meta name="viewport" content="width=device-width, initial-scale=1">
      <title>Admin Dashboard | Dashboard Data Monitor</title>
      <!-- Bootstrap -->
      <link href="media/css/bootstrap.min.css" rel="stylesheet">
      <!-- Font Awesome -->
      <link href="media/css/font-awesome.min.css" rel="stylesheet">
      <!-- Custom Theme Style -->
      <link href="media/css/custom.min.css" rel="stylesheet">
      <!-- Weather Style -->
      <link rel="stylesheet" type="text/css" href="media/css/jquery-ui.css"/>
      <link rel="stylesheet" href="media/css/weather.css" />
      <script src="media/js/jquery-min.js"></script>
      <script src="media/js/jquery-ui.js"></script>
      <script src="media/js/weather.js"></script>
      <script src="resources/config.js"></script>
      <!-- Include date range picker plugin -->
      <script type="text/javascript" src="media/js/datepicker/daterangepicker.js"></script>
      <link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/bootstrap.daterangepicker/1/daterangepicker-bs3.css" />
      <link rel="stylesheet" href="http://code.jquery.com/ui/1.8.23/themes/base/jquery-ui.css">
      <script src="media/js/jquery-ui.js"></script>
      <style type="text/css">
         .count{
         	font-size:18px !important;
         }h2{
         	font-size:23px !important;
         }h2.weather {
         	font-size:18px !important;
         }.today p{
         	font-size:13px !important;
         }.tile_stats_count .count {
         	line-height:20px !important;
         }.row {
         	margin-top:-12px !important;
         }h2.analysis {
         	font-size:28px !important;
         }.x_title span {
         	color: #5A738E !important;
		 }hr{
			margin-top: 0px !important;
		 }.nav > li > a {
			padding: 8px 12px 8px 12px !important;
		 }
      </style>
   </head>
   <body style="background-color:#ffffff;padding:0px 20px 0px 20px;">
      <div>
         <div style="text-align:center;font-size:26px;margin:2px;"><strong>Zambia â€“ Farmer SMS Data</strong></div>
         <!-- page content -->
         <div class="right_col" role="main"  style="margin:0 auto">
            <div>
               <ul class="nav nav-tabs" role="tablist" style="font-size:16px;">
                  <li class="active">
                     <a href="#tab-top-table1" data-toggle="tab">Zambia</a>
                  </li>
                  <!--<li>
                     <a href="#">Kenya</a>
                  </li>-->
               </ul>
               <div class="tab-content">
                  <div class="tab-pane active" id="tab-top-table1">
                     <div class="clearfix"></div>
                     <div class="col-md-12 col-sm-12 col-xs-12">
                        <div class="x_panel">
                           <div class="x_content">
                              <div>
                                 <div>
                                    <ul class="nav nav-tabs" role="tablist" style="font-size:14px">
                                       <li class="active">
                                          <a href="#tab-table1" data-toggle="tab">Monitoring</a>
                                       </li>
                                       <li>
                                          <a href="#tab-table2" data-toggle="tab">Tables and Metadata</a>
                                       </li>
                                    </ul>
                                    <div class="tab-content">
                                       <div class="tab-pane active" id="tab-table1">
                                          <h3 style="text-align:center;padding:0px 0px 10px 0px;font-size:20px">Weekly Overview <span class="count_top" id="lastweek" style="font-size:13px"></span></h3>
                                          <!-- top tiles -->
                                          <div class="row tile_count">
                                             <div class="col-md-6 col-sm-6 col-xs-6 tile_stats_count" style="text-align:center">
                                                <span class="count_top" style="font-size:15px;font-weight:600;">Flows Overview</span>
                                                <div style="text-align:center;"><span class="count_top" style="font-size:13px"> Total Flows  :  </span><span class="count blue" id="total_flows_count"></span></div>
                                                <div style="text-align:center;"><span class="count_top" style="font-size:13px"> Open Flows  :  </span><span class="count blue" id="open_flows_count"></span></div>
                                                <div style="text-align:center;"><span class="count_top" style="font-size:13px"> Started Last Week <span class="count_top" id="lastweek1"></span> <br>Flows  :  </span><span class="count blue" id="last_week_comp_flow_count"></span></div>
                                                <div style="text-align:center;"><span class="count_top" style="font-size:13px"> Resend Flows  :  </span><span class="count blue" id="last_week_comp_resend_flow_count"></span></div>
                                             </div>
                                             <div class="col-md-6 col-sm-6 col-xs-6 tile_stats_count" style="text-align:center">
                                                <span class="count_top" style="font-size:15px;font-weight:600;">Respondents(Contact) Overview</span>
                                                <div style="text-align:center;"><span class="count_top" style="font-size:13px"> Total Contacts  :  </span><span class="count blue" id="total_user_count"></span></div>
                                                <div style="text-align:center;"><span class="count_top" style="font-size:13px"> Active Last Week <span class="count_top" id="lastweek2"></span>  :  </span><span class="count blue" id="active_last_week"></span></div>
                                                <div style="text-align:center;"><span class="count_top" style="font-size:13px"> Inactive Last Week <span class= "count_top" id="lastweek3"></span>  :  </span><span class="count blue" id="inactive_last_week"></span></div>
                                                <div style="text-align:center;"><span class="count_top" style="font-size:13px"> No response for a month <span class= "count_top" id="lastweek4"></span>  :  </span><span class="count blue" id="no_response_last_month"></span></div>
                                             </div>
                                          </div>
                                          <hr>
                                          </hr>
                                          <div class="clearfix" style="padding:10px;"></div>
                                          <div class="row">
                                             <div class="col-md-6 col-sm-6 col-xs-6">
                                                <div class="dashboard_graph x_panel">
                                                   <div class="row x_title">
                                                      <div class="col-md-5">
                                                         <h3 style="font-size:20px">Daily run completion rate <span class="count_top" id="lastweek6" style="font-size:11px"></span></h3>
                                                      </div>
                                                      <div class="col-md-7">
                                                         <div id="reportrange1" class="pull-right" style="background: #fff; cursor: pointer; padding: 5px 0px;">
                                                            <label for="sel1">Select flow:</label>
                                                            <select id="sel1">
                                                            </select>
                                                         </div>
                                                      </div>
                                                      <hr>
                                                      <div class="form-group">
                                                         <div class="col-md-9 col-sm-9 col-xs-12 col-md-offset-3">
                                                            <button type="submit" class="btn btn-success pull-right" id="saveBtn1">Submit</button>
                                                         </div>
                                                      </div>
                                                   </div>
                                                   <div>
                                                      <div id="chartContainer1" class="demo-placeholder" style="height:350px !important;width:100% !important;"></div>
                                                   </div>
                                                   <div class="clearfix"></div>
                                                </div>
                                             </div>
                                             <div class="col-md-6 col-sm-6 col-xs-6">
                                                <div class="dashboard_graph x_panel">
                                                   <div class="row x_title">
                                                      <div class="col-md-5">
                                                         <h3 style="font-size:20px">Flow completion rate <span class="count_top" id="lastweek5" style="font-size:11px"></span></h3>
                                                      </div>
                                                      <div class="col-md-7">
                                                         <div id="reportrange2" class="pull-right" style="background: #fff; cursor: pointer; padding: 5px 0px;">
                                                            <label for="sel2">Select flow:</label>
                                                            <select id="sel2">
                                                            </select>
                                                         </div>
                                                      </div>
                                                      <hr>
                                                      <div class="form-group">
                                                         <div class="col-md-9 col-sm-9 col-xs-12 col-md-offset-3">
                                                            <button type="submit" class="btn btn-success pull-right" id="saveBtn2">Submit</button>
                                                         </div>
                                                      </div>
                                                   </div>
                                                   <div>
                                                      <div id="chartContainer2" class="demo-placeholder" style="height:350px !important;width:100% !important;"></div>
                                                   </div>
                                                   <div class="clearfix"></div>
                                                </div>
                                             </div>
                                          </div>
                                          <hr>
                                       </div>
                                       <div class="tab-pane" id="tab-table2">
                                          <div style="margin-top:20px;"></div>
                                          <h4>Click below buttons to access your needful tables</h4>
                                          <div style="margin-top:20px;"></div>
                                          <a href="flow-metadata.html" class="btn btn-default active" role="button">Flow Metadata Management</a>
                                          <a href="contact-metadata.html" class="btn btn-default active" role="button">Contact Metadata Management</a>
                                          <a href="inactive-contacts.html" class="btn btn-default active" role="button">Download Inactive Contacts</a>
                                          <a href="question-response.html" class="btn btn-default active" role="button">Download Farmers Responses</a>
                                          <div style="margin-top:50px;"></div>
                                       </div>
                                    </div>
                                 </div>
                              </div>
                           </div>
                        </div>
                     </div>
                  </div>
               </div>
               <!-- /page content -->
               <!-- footer content -->
               <div class="right_col">
                  <footer>
                     <div class="pull-right">
                        Dashboard Data Monitor - Admin Monitoring UI
                     </div>
                     <div class="clearfix"></div>
                  </footer>
               </div>
               <!-- /footer content -->
            </div>
         </div>
      </div>
      <!-- Bootstrap -->
      <script src="media/js/bootstrap.min.js"></script>
      <!-- bootstrap-daterangepicker -->
      <script src="media/js/moment/moment.min.js"></script>
      <script src="media/js/datepicker/daterangepicker.js"></script>
      <!-- Custom Theme Scripts -->
      <script src="media/js/custom.min.js"></script>
      <script type="text/javascript" src="media/js/jquery.dataTables.min.js"></script>
      <script type="text/javascript" src="media/js/jquery.canvasjs.min.js"></script>
      <script type="text/javascript">
         $(document).ready(function() {
		 if (gOptions.enabled) {
			 var textit_prefix = gOptions.zam_api_url;
			 var uname = gOptions.uname;
			 var pwd = gOptions.pwd;
		 }
         
         function getLastWeek(){
         var today = new Date();
         var lastWeek = new Date(today.getFullYear(), today.getMonth(), today.getDate() - 7);
         return lastWeek;
         }
         
         function getLastSunday() {
         var now = new Date();
         var today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
         var lastSunday = new Date(today.setDate(today.getDate()-today.getDay()));
         return lastSunday;
         }
         
         function getLastBeforeMonday(){
         var now = new Date();
         var today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
         var lastMonday = new Date(today.setDate(today.getDate()-(today.getDay()-1)%7));
         var beforeMonday = new Date(lastMonday.getFullYear(), lastMonday.getMonth(), lastMonday.getDate()-7);
         return beforeMonday;
         }
         
         function getLastMonday(){
         var now = new Date();
         var today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
         var lastMonday = new Date(today.setDate(today.getDate()-(today.getDay()-1)%7));
         return lastMonday;
         }
			 
		 function make_base_auth(user, password) {
			var tok = user + ':' + password;
			var hash = btoa(tok);
			return 'Basic ' + hash;
		 }
         
         var now = new Date();
         var today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
         var lastMonth = new Date(now.getFullYear(), now.getMonth()-1, now.getDate());
         var lastWeek = getLastWeek();
         var lastSunday = getLastSunday();
         var lastBeforeMonday = getLastBeforeMonday();
         var lastMonday = getLastMonday();	
         
         lastweek_output = '<strong>[' + moment(lastBeforeMonday).format('MMMM Do YYYY') + ' - ' + moment(lastMonday).format('MMMM Do YYYY') + ']</strong>';
         lastmonth_output = '<strong>[' + moment(lastMonth).format('MMMM Do YYYY') + ' - ' + moment(today).format('MMMM Do YYYY') + ']</strong>';
         $("#lastweek").html(lastweek_output);
         $("#lastweek1").html(lastweek_output);
         $("#lastweek2").html(lastweek_output);
         $("#lastweek3").html(lastweek_output);
         $("#lastweek4").html(lastmonth_output);
         $("#lastweek5").html(lastweek_output);
         $("#lastweek6").html(lastweek_output);
         	
         open_flows = [];
         
         /* Inactive Farmers - for last month*/
         var now = new Date();
         var today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
         var last_respond_date = new Date(today.getFullYear(), today.getMonth()-1, today.getDate());
         var last_respond_to_date = moment(last_respond_date).format("YYYY-MM-DDTHH:mm:ss.SSS");
         $.ajax({
         url: textit_prefix + "/inactivecontacts?lastRespondedSort=1&lastRespondedTo=" + last_respond_to_date,
		 beforeSend: function (xhr) {
		 	xhr.setRequestHeader('Authorization', make_base_auth(uname, pwd));
		 },
         success: function (lrcdata) {
         var total_lrc_contacts = lrcdata.length
         $("#no_response_last_month").html(total_lrc_contacts);
         
         }
         });
         
         /* End : Inactive Farmers - for last month*/
         
         
         /* Inactive Farmers - for last week*/
         var last_respond_to_date = moment(lastBeforeMonday).format("YYYY-MM-DDTHH:mm:ss.SSS");
         $.ajax({
         url: textit_prefix + "/inactivecontacts?lastRespondedSort=1&lastRespondedTo=" + last_respond_to_date,
		 beforeSend: function (xhr) {
		 	xhr.setRequestHeader('Authorization', make_base_auth(uname, pwd));
		 },
         success: function (lrcdata) {
         var week_inactive_contacts = lrcdata.length
         $("#inactive_last_week").html(week_inactive_contacts);
         
         }
         });
         
         /* End : Inactive Farmers - for last week*/
         
         /* active Farmers - for last week*/
         var last_respond_from_date = moment(lastBeforeMonday).format("YYYY-MM-DDTHH:mm:ss.SSS");
         var last_respond_to_date = moment(lastMonday).format("YYYY-MM-DDTHH:mm:ss.SSS");
         $.ajax({
         url: textit_prefix + "/giventimeactivecontacts?lastRespondedSort=1&lastRespondedFrom=" + last_respond_from_date + "&lastRespondedTo=" + last_respond_to_date,
		 beforeSend: function (xhr) {
		 	xhr.setRequestHeader('Authorization', make_base_auth(uname, pwd));
		 },
         success: function (lrcdata) {
         var week_active_contacts = lrcdata.length
         $("#active_last_week").html(week_active_contacts);
         
         }
         });
         
         /* End : active Farmers - for last week*/
         
         
         $.ajax({
         url: textit_prefix + "/flows",
		 beforeSend: function (xhr) {
		 	xhr.setRequestHeader('Authorization', make_base_auth(uname, pwd));
		 },
         success: function (data) {
         var total_flows = data.length;
         for (i in data) {
         someDate = new Date(data[i].created_on);						
         if (new Date(someDate.setDate(someDate.getDate() + data[i].expires/(60*24))) > lastSunday){							
         	open_flows.push(data[i].created_on)
         }
         }
         $("#total_flows_count").html(total_flows);
         $("#open_flows_count").html(open_flows.length);
         
         }
         });
         
         var total_contacts=0;
         $.ajax({
         url: textit_prefix + "/contacts",
		 beforeSend: function (xhr) {
		 	xhr.setRequestHeader('Authorization', make_base_auth(uname, pwd));
		 },
         success: function (cdata) {
         total_contacts = cdata.length;
         
         $("#total_user_count").html(total_contacts);
         }
         });
         
         resend_flow = [];
         $.ajax({
         url: textit_prefix + "/lastweekflowcompletion",
		 beforeSend: function (xhr) {
		 	xhr.setRequestHeader('Authorization', make_base_auth(uname, pwd));
		 },
         success: function (lcomp) {
         lcomp_flows = lcomp.length;
         for (i in lcomp) {
         
         if (lcomp[i].flow_name.indexOf("resend") >= 0){
         	resend_flow.push(lcomp[i].flow_name);
         }					
         }
         	$("#last_week_comp_flow_count").html(lcomp_flows);
            $("#last_week_comp_resend_flow_count").html(resend_flow.length);
         }
         });
         });
         
      </script>      
      <script>
         $(document).ready(function() { 
         	if (gOptions.enabled) {
			 var textit_prefix = gOptions.zam_api_url;
			 var uname = gOptions.uname;
			 var pwd = gOptions.pwd;
		 	}
         	var now = new Date();
         	var today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
         	var lastMonday = new Date(today.setDate(today.getDate()-(today.getDay()-1)%7));
         	var beforeMonday = new Date(lastMonday.getFullYear(), lastMonday.getMonth(), lastMonday.getDate()-7);
         	var lastMondayNew = moment(new Date(today.setDate(today.getDate()-(today.getDay()-1)%7))).format('D MMMM YYYY');
         	
         	var beforeMondayNew = moment(new Date(lastMonday.getFullYear(), lastMonday.getMonth(), lastMonday.getDate()-7)).format('D MMMM YYYY');
         	var beforeTuesday = moment(new Date(lastMonday.getFullYear(), lastMonday.getMonth(), lastMonday.getDate()-6)).format('D MMMM YYYY');
         	var beforeWednesday = moment(new Date(lastMonday.getFullYear(), lastMonday.getMonth(), lastMonday.getDate()-5)).format('D MMMM YYYY');
         	var beforeThursday = moment(new Date(lastMonday.getFullYear(), lastMonday.getMonth(), lastMonday.getDate()-4)).format('D MMMM YYYY');
         	var beforeFriday = moment(new Date(lastMonday.getFullYear(), lastMonday.getMonth(), lastMonday.getDate()-3)).format('D MMMM YYYY');
         	var beforeSaturday = moment(new Date(lastMonday.getFullYear(), lastMonday.getMonth(), lastMonday.getDate()-2)).format('D MMMM YYYY');
         	var beforeSunday = moment(new Date(lastMonday.getFullYear(), lastMonday.getMonth(), lastMonday.getDate()-1)).format('D MMMM YYYY');
         
         	tdate = new Date(moment(lastMonday).format('D MMMM YYYY'));
         	tdate_sr = new Date(tdate.setHours(tdate.getHours()+12))
         	tdate_sr_lk = moment(tdate_sr).format("YYYY-MM-DDTHH:mm:ss.SSS");
         
         	fdate = new Date(moment(beforeMonday).format('D MMMM YYYY'));
         	fdate_sr = new Date(fdate.setHours(fdate.getHours()+12))
         	fdate_sr_lk = moment(fdate_sr).format("YYYY-MM-DDTHH:mm:ss.SSS");
         
         	var to_date = tdate_sr_lk + "Z";
         	var from_date = fdate_sr_lk + "Z";
         	var last_week_flows = [];
			 
			var lat_from_date = "2015-12-01T12:00:00.000Z";
         	
         	Date.prototype.getWeek = function() {
         	var onejan = new Date(this.getFullYear(), 0, 1);
         	return Math.ceil((((this - onejan) / 86400000) + onejan.getDay() + 1) / 7);
         	}
         
         	var weekNumber = (beforeMonday).getWeek();
			
			function make_base_auth(user, password) {
			var tok = user + ':' + password;
			var hash = btoa(tok);
			return 'Basic ' + hash;
			}
         	
         	$.ajax({
				url: textit_prefix + "/giventimeflowcompletion?from=" + lat_from_date + "&to=" + to_date,
			    beforeSend: function (xhr) {
					xhr.setRequestHeader('Authorization', make_base_auth(uname, pwd));
			    },
				success: function (fdata) {
				for (i in fdata) {
					last_week_flows.push({"flow_name":fdata[i].flow_name, "uuid":fdata[i].uuid, "deployed_on":fdata[i].deployed_on});
				}							
							
				var date_sort_desc = function (date1, date2) {
				  if (new Date(date1.deployed_on) > new Date(date2.deployed_on)) return -1;
				  if (new Date(date1.deployed_on) < new Date(date2.deployed_on)) return 1;
				  return 0;
				};
							
				last_week_flows.sort(date_sort_desc);
         	 
         		var options = "";
         		for(var i=0; i< last_week_flows.length; i++){
         			options += '<option value ="' + last_week_flows[i].uuid + '">' + last_week_flows[i].flow_name + '</option>';
         		}
         			
         		$("#sel1").append(options);
         		$("#sel2").append(options);
         		
         		},
         		async: false
         	});
         
           		
         	answer = $('#sel1 option:selected').val();	
         	answer2 = $('#sel2 option:selected').val();	
         	
         	/*  1st graph - Daily run completion rate*/
         	$.ajax({
         		url: textit_prefix + "/givenflowidflowcompletion?flowId=" + answer,
			    beforeSend: function (xhr) {
					xhr.setRequestHeader('Authorization', make_base_auth(uname, pwd));
			    },				
         		success: function (sdata) {
         
         		response_array = [];
         		non_response_array = [];
         		atleast_response_array = [];
         		days = [beforeMondayNew, beforeTuesday, beforeWednesday, beforeThursday, beforeFriday, beforeSaturday, beforeSunday];
         
         		for (f in sdata){
         			
         			if (sdata[f].total_runs != 0){
         				for (var j=0; j<14; j++){
         					if(j % 2 == 1){
         						k = j/2-1/2;
         						if (sdata[f].responded_matrix[j] != undefined){
         							
         							non_response_array.push({"label" : days[k], "y" : sdata[f].non_responded_matrix[j].perc, "cat_name" : "No answer at all"});
         
         							response_array.push({"label" : days[k], "y" : sdata[f].matrix[j].perc, "cat_name" : "Runs completed"});
         
         							atleast_response_array.push({"label" : days[k], "y" : sdata[f].responded_matrix[j].perc, "cat_name" : "Answered atleast one question"});
         
         						}else{
         
         							non_response_array.push({"label" : days[k], "y" : non_response_array[non_response_array.length-1].y, "cat_name" : "No answer at all"});
         
         							response_array.push({"label" : days[k], "y" : response_array[response_array.length-1].y, "cat_name" : "Runs completed"});
         
         							atleast_response_array.push({"label" : days[k], "y" : atleast_response_array[atleast_response_array.length-1].y, "cat_name" : "Answered atleast one question"});
         						}
         					}
         			}
         
         			}
         			
         			total_runs_flow = sdata[f].total_runs;
         			runs_flow_name = sdata[f].flow_name;
         		}
         			
         		}
         	});
         
         	setTimeout(function () {
				
				
         
         	var chart = new CanvasJS.Chart("chartContainer1",
         		{
         			subtitles:[{
         				text: "Flow - " + runs_flow_name
         			},{
         				text: "Week# - " + weekNumber
         			},
         			{
         				text: "Total runs sent - " + total_runs_flow
         			}
         			],
         			axisY:{
         				title: "Respond rate (in %)",
         	   		},
         			axisX: {
         				title: "Time (in day)"
         			},
         			exportEnabled: true,					
         			data: [
         			{
         				type: "column",
         				name: "Runs completed",
         				legendText: "Runs completed",
         				indexLabel: "{y}%",
         				indexLabelFontSize: 10,
         				showInLegend: true,
         				//toolTipContent: "{cat_name} - {y} %",
         				dataPoints:response_array
         			},
         			{
         				type: "column",
         				name: "No answer at all",
         				legendText: "No answer at all",
         				indexLabel: "{y}%",
         				indexLabelFontSize: 10,
         				showInLegend: true,
         				//toolTipContent: "{cat_name} - {y} %",
         				dataPoints:non_response_array
         			},
         			{
         				type: "column",
         				name: "Answered atleast one question",
         				legendText: "Answered atleast one question",
         				indexLabel: "{y}%",
         				indexLabelFontSize: 10,
         				showInLegend: true,
         				//toolTipContent: "{cat_name} - {y} %",
         				dataPoints:atleast_response_array
         			}
         
         			],
         		  legend:{
         			cursor:"pointer",
         			itemclick: function(e){
         			  if (typeof(e.dataSeries.visible) === "undefined" || e.dataSeries.visible) {
         				e.dataSeries.visible = false;
         			  }
         			  else {
         				e.dataSeries.visible = true;
         			  }
         				chart.render();
         			}
         		  },
         		});
         	
         	chart.render();
         
         	}, 2000);
         	
         	
         /*  1st graph change after save clicks*/
         $('#saveBtn1').click(function(){
         
         	var selected_flow_id = $("#sel1").find("option:selected").val();
         	
         	$.ajax({
         		url: textit_prefix + "/givenflowidflowcompletion?flowId=" + selected_flow_id,
			    beforeSend: function (xhr) {
					xhr.setRequestHeader('Authorization', make_base_auth(uname, pwd));
			    },
         		success: function (sdata) {
         
         		response_array = [];
         		non_response_array = [];
         		atleast_response_array = [];
         		days = [beforeMondayNew, beforeTuesday, beforeWednesday, beforeThursday, beforeFriday, beforeSaturday, beforeSunday];
         
         		for (f in sdata){
         			
         			if (sdata[f].total_runs != 0){
         				for (var j=0; j<14; j++){
         					if(j % 2 == 1){
         						k = j/2-1/2;
         						if (sdata[f].responded_matrix[j] != undefined){
         
         							non_response_array.push({"label" : days[k], "y" : sdata[f].non_responded_matrix[j].perc, "cat_name" : "No answer at all"});
         
         							response_array.push({"label" : days[k], "y" : sdata[f].matrix[j].perc, "cat_name" : "Runs completed"});
         
         							atleast_response_array.push({"label" : days[k], "y" : sdata[f].responded_matrix[j].perc, "cat_name" : "Answered atleast one question"});
         
         						}else{
         
         							non_response_array.push({"label" : days[k], "y" : non_response_array[non_response_array.length-1].y, "cat_name" : "No answer at all"});
         
         							response_array.push({"label" : days[k], "y" : response_array[response_array.length-1].y, "cat_name" : "Runs completed"});
         
         							atleast_response_array.push({"label" : days[k], "y" : atleast_response_array[atleast_response_array.length-1].y, "cat_name" : "Answered atleast one question"});
         						}
         					}
         			}
         
         			}
         			total_runs_flow = sdata[f].total_runs;
         			runs_flow_name = sdata[f].flow_name;
         		}
         		}
         	});
         
         	setTimeout(function () {
         
         	var chart = new CanvasJS.Chart("chartContainer1",
         		{
         			subtitles:[{
         				text: "Flow - " + runs_flow_name
         			},{
         				text: "Week# - " + weekNumber
         			},
         			{
         				text: "Total runs sent - " + total_runs_flow
         			}],
         			axisY:{
         			title: "Respond rate (in %)",
         	   		},
         			axisX: {
         				title: "Time (in day)"
         			},
         			exportEnabled: true,
         			data: [
         			{
         				type: "column",
         				name: "Runs completed",
         				legendText: "Runs completed",
         				indexLabel: "{y}%",
         				indexLabelFontSize: 10,
         				showInLegend: true,
         				dataPoints:response_array
         			},
         			{
         				type: "column",
         				name: "No answer at all",
         				legendText: "No answer at all",
         				indexLabel: "{y}%",
         				indexLabelFontSize: 10,
         				showInLegend: true,
         				dataPoints:non_response_array
         			},
         			{
         				type: "column",
         				name: "Answered atleast one question",
         				legendText: "Answered atleast one question",
         				indexLabel: "{y}%",
         				indexLabelFontSize: 10,
         				showInLegend: true,
         				dataPoints:atleast_response_array
         			}
         
         			],
         		  legend:{
         			cursor:"pointer",
         			itemclick: function(e){
         			  if (typeof(e.dataSeries.visible) === "undefined" || e.dataSeries.visible) {
         				e.dataSeries.visible = false;
         			  }
         			  else {
         				e.dataSeries.visible = true;
         			  }
         				chart.render();
         			}
         		  },
         		});
         	
         	chart.render();
         
         	}, 2000);
         
           });
         	
         
         	
         	/*  2nd graph - Flow completion rate*/
         	$.ajax({
         		url: textit_prefix + "/givenflowidflowcompletion?flowId=" + answer2,
			    beforeSend: function (xhr) {
					xhr.setRequestHeader('Authorization', make_base_auth(uname, pwd));
			    },				
         		success: function (sdata) {
         
         		graph2_response_array = [];
         		graph2_non_response_array = [];
         		graph2_atleast_response_array = [];
         		week_com = beforeMondayNew + " to " + lastMondayNew;
         
         		for (f in sdata){
         			
         				if (sdata[f].total_runs != 0){
         						mat_len = sdata[f].matrix.length - 1
         						non_mat_len = sdata[f].non_responded_matrix.length - 1
         						atl_mat_len = sdata[f].responded_matrix.length - 1
         						if (sdata[f].matrix[mat_len] != undefined){
         							
         							graph2_non_response_array.push({"label" : week_com, "y" : sdata[f].non_responded_matrix[non_mat_len].abs, "cat_name" : "Farmers with no answer at all"});
         
         							graph2_response_array.push({"label" : week_com, "y" : sdata[f].matrix[mat_len].abs, "cat_name" : "Farmers who completed the flow"});
         
         							graph2_atleast_response_array.push({"label" : week_com, "y" : sdata[f].responded_matrix[atl_mat_len].abs, "cat_name" : "Farmers who answered any question"});
         
         						}else{
         
         							graph2_non_response_array.push({"label" : week_com, "y" : graph2_non_response_array[graph2_non_response_array.length-1].y, "cat_name" : "Farmers with no answer at all"});
         
         							graph2_response_array.push({"label" : week_com, "y" : graph2_response_array[graph2_response_array.length-1].y, "cat_name" : "Farmers who completed the flow"});
         
         							graph2_atleast_response_array.push({"label" : week_com, "y" : graph2_atleast_response_array[graph2_atleast_response_array.length-1].y, "cat_name" : "Farmers who answered any question"});
         						}
         			}
         			
         			graph2_total_runs_flow = sdata[f].total_runs;
         			graph2_runs_flow_name = sdata[f].flow_name;
         		}
         			
         		}
         	});
         
         	setTimeout(function () {
         
         	var chart = new CanvasJS.Chart("chartContainer2",
         		{
         			subtitles:[{
         				text: "Flow - " + graph2_runs_flow_name
         			},{
         				text: "Week# - " + weekNumber
         			},
         			{
         				text: "Total farmers sent - " + graph2_total_runs_flow
         			}
         			],
         			axisY:{
         				title: "# of farmers",
         	   		},
         			axisX: {
         				title: "Time (in week)"
         			},
         			exportEnabled: true,					
         			data: [
         			{
         				type: "column",
         				name: "Farmers who completed the flow",
         				legendText: "Farmers who completed the flow",
         				indexLabel: "{y}",
         				indexLabelFontSize: 10,
         				showInLegend: true,
         				//toolTipContent: "{cat_name} - {y} %",
         				dataPoints:graph2_response_array
         			},
         			{
         				type: "column",
         				name: "Farmers with no answer at all",
         				legendText: "Farmers with no answer at all",
         				indexLabel: "{y}",
         				indexLabelFontSize: 10,
         				showInLegend: true,
         				//toolTipContent: "{cat_name} - {y} %",
         				dataPoints:graph2_non_response_array
         			},
         			{
         				type: "column",
         				name: "Farmers who answered any question",
         				legendText: "Farmers who answered any question",
         				indexLabel: "{y}",
         				indexLabelFontSize: 10,
         				showInLegend: true,
         				//toolTipContent: "{cat_name} - {y} %",
         				dataPoints:graph2_atleast_response_array
         			}
         
         			],
         		  legend:{
         			cursor:"pointer",
         			itemclick: function(e){
         			  if (typeof(e.dataSeries.visible) === "undefined" || e.dataSeries.visible) {
         				e.dataSeries.visible = false;
         			  }
         			  else {
         				e.dataSeries.visible = true;
         			  }
         				chart.render();
         			}
         		  },
         		});
         	
         	chart.render();
         
         	}, 2000);
         	
         	
         /*  2nd graph change after save clicks*/
         $('#saveBtn2').click(function(){
         
         	var selected_flow_id = $("#sel2").find("option:selected").val();
         	
         	$.ajax({
         		url: textit_prefix + "/givenflowidflowcompletion?flowId=" + selected_flow_id,
			    beforeSend: function (xhr) {
					xhr.setRequestHeader('Authorization', make_base_auth(uname, pwd));
			    },
         		success: function (s2data) {
         
         		graph2_response_array = [];
         		graph2_non_response_array = [];
         		graph2_atleast_response_array = [];
         		week_com = beforeMondayNew + " to " + lastMondayNew;
         
         		for (g in s2data){
         			
         				if (s2data[g].total_runs != 0){
         						mat_len = s2data[g].matrix.length - 1
         						non_mat_len = s2data[g].non_responded_matrix.length - 1
         						atl_mat_len = s2data[g].responded_matrix.length - 1
         						if (s2data[g].matrix[mat_len] != undefined){
         
         							graph2_non_response_array.push({"label" : week_com, "y" : s2data[g].non_responded_matrix[non_mat_len].abs, "cat_name" : "No answer at all"});
         
         							graph2_response_array.push({"label" : week_com, "y" : s2data[g].matrix[mat_len].abs, "cat_name" : "Runs completed"});
         
         							graph2_atleast_response_array.push({"label" : week_com, "y" : s2data[g].responded_matrix[atl_mat_len].abs, "cat_name" : "Answered atleast one question"});
         
         						}else{
         
         							graph2_non_response_array.push({"label" : week_com, "y" : graph2_non_response_array[graph2_non_response_array.length-1].y, "cat_name" : "No answer at all"});
         
         							graph2_response_array.push({"label" : week_com, "y" : graph2_response_array[graph2_response_array.length-1].y, "cat_name" : "Runs completed"});
         
         							graph2_atleast_response_array.push({"label" : week_com, "y" : graph2_atleast_response_array[graph2_atleast_response_array.length-1].y, "cat_name" : "Answered atleast one question"});
         						}							
         
         			}
         			graph2_total_runs_flow = s2data[g].total_runs;
         			graph2_runs_flow_name = s2data[g].flow_name;
         		}
         		}
         	});
         
         	setTimeout(function () {
         
         	var chart = new CanvasJS.Chart("chartContainer2",
         		{
         			subtitles:[{
         				text: "Flow - " + graph2_runs_flow_name
         			},{
         				text: "Week# - " + weekNumber
         			},
         			{
         				text: "Total farmers sent - " + graph2_total_runs_flow
         			}
         			],
         			axisY:{
         				title: "# of farmers",
         	   		},
         			axisX: {
         				title: "Time (in week)"
         			},
         			exportEnabled: true,					
         			data: [
         			{
         				type: "column",
         				name: "Farmers who completed the flow",
         				legendText: "Farmers who completed the flow",
         				indexLabel: "{y}",
         				indexLabelFontSize: 10,
         				showInLegend: true,
         				//toolTipContent: "{cat_name} - {y} %",
         				dataPoints:graph2_response_array
         			},
         			{
         				type: "column",
         				name: "Farmers with no answer at all",
         				legendText: "Farmers with no answer at all",
         				indexLabel: "{y}",
         				indexLabelFontSize: 10,
         				showInLegend: true,
         				//toolTipContent: "{cat_name} - {y} %",
         				dataPoints:graph2_non_response_array
         			},
         			{
         				type: "column",
         				name: "Farmers who answered any question",
         				legendText: "Farmers who answered any question",
         				indexLabel: "{y}",
         				indexLabelFontSize: 10,
         				showInLegend: true,
         				//toolTipContent: "{cat_name} - {y} %",
         				dataPoints:graph2_atleast_response_array
         			}
         
         			],
         		  legend:{
         			cursor:"pointer",
         			itemclick: function(e){
         			  if (typeof(e.dataSeries.visible) === "undefined" || e.dataSeries.visible) {
         				e.dataSeries.visible = false;
         			  }
         			  else {
         				e.dataSeries.visible = true;
         			  }
         				chart.render();
         			}
         		  },
         		});
         	
         	chart.render();
         
         	}, 2000);
         
           	});
         });
      </script>
   </body>
</html>